#!/bin/sh

# cumtos ntp
uci delete system.ntp.server
uci add_list system.ntp.server='ntp1.aliyun.com'
uci add_list system.ntp.server='time1.cloud.tencent.com'
uci add_list system.ntp.server='time.ustc.edu.cn'
uci add_list system.ntp.server='cn.pool.ntp.org'
#uci set system.ntp.enable_server='1'
uci commit system

# set default theme
#uci set luci.main.mediaurlbase=/luci-static/argon
uci set luci.main.mediaurlbase=/luci-static/material
uci commit luci

# set lan ip
uci set network.lan.ipaddr='192.168.11.1'
uci set network.lan.netmask='255.255.255.0'
uci commit network

# disable redirect https 
uci set uhttpd.main.redirect_https='0'
uci commit uhttpd

# remove feeds repository
sed -i '/helloworld/d' /etc/opkg/distfeeds.conf
sed -i '/passwall/d' /etc/opkg/distfeeds.conf
sed -i '/n2n/d' /etc/opkg/distfeeds.conf

# move menu
sed -i 's/\"network\"/\"control\"/g' /usr/lib/lua/luci/controller/appfilter.lua
sed -i 's/\"services\"/\"control\"/g' /usr/lib/lua/luci/controller/mia.lua

sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/aria2.lua
sed -i 's/services/nas/g' /usr/lib/lua/luci/view/aria2/overview_status.htm
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/hd_idle.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/samba.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/minidlna.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/transmission.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/mjpg-streamer.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/p910nd.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/usb_printer.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/xunlei.lua
sed -i 's/services/nas/g'  /usr/lib/lua/luci/view/minidlna_status.htm

# anti-ad auto update for smartdns
if [ -f "/etc/smartdns/anti-ad.sh" ]; then
    echo "0 5 * * * /etc/smartdns/anti-ad.sh > /dev/null 2>&1 &" >>/etc/crontabs/root

    # disable dnsmasq dns cache
    uci set dhcp.@dnsmasq[0].dns_redirect='0'
    uci set dhcp.@dnsmasq[0].cachesize='0'
    uci set dhcp.@dnsmasq[0].server='127.0.0.1#7055'
    uci commit dhcp
fi

# passwall tool
if [ -f "/usr/share/passwall/curl_ping.sh" ]; then
    ln -s /usr/share/passwall/curl_ping.sh /usr/bin/curl_ping
fi

# firewall.user
# NTP
#sed -i '/REDIRECT --to-ports 123/d' /etc/firewall.user
#echo "iptables -t nat -A PREROUTING -p udp --dport 123 -j REDIRECT --to-ports 123" >>/etc/firewall.user

exit 0
